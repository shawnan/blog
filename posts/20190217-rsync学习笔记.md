# rsync学习笔记

## rsync简介
rsync是一个开源的应用程序，提供快速、增量的文件传输，可以实现远程或本地的文件复制。简单来说， 就是可以用来同步文件，但是它只会同步不同的部分，比直接copy覆盖的速度要快，尤其是在文件整体很大改动又很小的情况下，rsync的速度远远快于copy覆盖。  
<! --more -->
## 安装
### yum安装
yum install rsync -y

### 源码编译
#### 下载源码
wget https://download.samba.org/pub/rsync/rsync-3.1.3.tar.gz

#### 解压源码
tar -zxvf rsync-3.1.3.tar.gz

#### 运行配置脚本
sh -x configure --prefix=/usr/local/rsync/

#### 编译
make

#### 执行安装
make install

## 用法
rsync的用法与rcp类似，必须同时指定源和目标，如果不指定目标，则会执行列出文件。

### 本地模式
本地模式可以用于在同一台机器上进行文件目录同步。
rsync [OPTION...] SRC... [DEST] --同步SRC目录到DEST

rsync -av src/ dest/ --将 src 目录整个同步至 dest 目录（不包含src目录）
rsync -av src dest/ --将 src 目录包括自己整个同步至 dest 目录
rsync -avR src/ dest/ --即使 src 后面接有 / ，也同步src目录
rsync -av --delete src/ dest/ --同步的时候从 dest 目录中删除 src 中没有的目录


### 远程SSH模式
远程模式用于在不同机器建进行文件目录同步，用法类似于本地模式，只是在目录前加了主机名或主机IP。
rsync [OPTION...] [USER@]HOST:SRC... [DEST] --HOST主机拉取到本地DEST目录
rsync [OPTION...] SRC... [USER@]HOST:DEST  --本地推送到HOST主机的DEST目录

rsync -av test/ 10.44.219.190:/home/IotServer/test --本地的test目录推到190机器上

如果想要在执行rsync命令的时候不输入密码，则需要配置ssh无密码登录，将本机的公钥copy到目标机器的authorized_keys。同样，远程ssh模式的时候也可以使用--delete选项删除文件。

### 守护进程模式
守护进程模式可用于两台服务器之间的远程文件同步，守护进行模式需要启动一个进程。这个进程监听873端口，等待客户端连接，客户端连接时需要携带口令，若口令正确，则允许连接并进行文件同步。
#### 服务启动方式
守护进程模式有两种方式启动，一种是作为独立服务启动，一种是托管给xinted。
##### 独立服务方式
/usr/bin/rsync --daemon --config=/etc/rsyncd/rsyncd.conf
--默认配置文件是/etc/rsyncd.conf，可以利用"--config"显式指定配置文件


##### 托管给xinted方式
yum install rsync xinetd --服务安装
vim /etc/xinetd.d/rsync --配置托管服务，将disable改为 no 
/etc/init.d/xinetd start --启动托管服务 xinetd
chkconfig rsync on --设置服务自启动
netstat -ntpl | grep 873 --查看服务是否启动


#### 配置文件
两种rsync 服务运行方式都需要配置rsyncd.conf配置文件。
##### 配置详解
1、全局参数
在全局参数部分也可以定义模块参数，这时该参数的值就是所有模块的默认值
address --在独立运行时，用于指定的服务器运行的 IP 地址；由 xinetd 运行时将忽略此参数，使用命令行上的 –address 选项替代。默认本地所有IP
port --指定 rsync 守护进程监听的端口号。 由 xinetd 运行时将忽略此参数，使用命令行上的 –port 选项替代。默认 873
motd file --指定一个消息文件，当客户连接服务器时该文件的内容显示给客户
pid file --rsync 的守护进程将其 PID 写入指定的文件
log file --指定 rsync 守护进程的日志文件，而不将日志发送给 syslog
syslog facility --指定 rsync 发送日志消息给 syslog 时的消息级别
socket options --指定自定义 TCP 选项
lockfile --指定rsync的锁文件存放路径
timeout = 600 --超时时间
模块参数
模块参数主要用于定义 rsync 服务器哪个目录要被同步。模块声明的格式必须为 [module] 形式，这个名字就是在 rsync 客户端看到的名字，类似于 Samba 服务器提供的共享名。而服务器真正同步的数据是通过 path 来指定的
基本模块参数
path --指定当前模块在 rsync 服务器上的同步路径，该参数是必须指定的
comment --给模块指定一个描述，该描述连同模块名在客户连接得到模块列表时显示给客户
模块控制参数
use chroot = --默认为 true，在传输文件之前首先 chroot 到 path 参数所指定的目录下；优点，安全；缺点，需要 root 权限，不能备份指向 path 外部的符号连接所指向的目录文件
uid = --指定该模块以指定的 UID 传输文件；默认nobody
gid = --指定该模块以指定的 GID 传输文件；默认nobody
max connections --最大并发连接数，0为不限制
lock file --指定支持 max connections 参数的锁文件。默认 /var/run/rsyncd.lock
list --指定当客户请求列出可以使用的模块列表时，该模块是否应该被列出。默认为 true，显示
read only = --只读选择，也就是说，不让客户端上传文件到服务器上。默认true
write only = --只写选择，也就是说，不让客户端从服务器上下载文件。默认false
ignore errors --忽略IO错误。默认true
ignore nonreadable --指定 rysnc 服务器完全忽略那些用户没有访问权限的文件。这对于在需要备份的目录中有些不应该被备份者获得的文件时是有意义的。 false
timeout = --该选项可以覆盖客户指定的 IP 超时时间。从而确保 rsync 服务器不会永远等待一个崩溃的客户端。对于匿名 rsync 服务器来说，理想的数字是 600（单位为秒）。 0 (未限制)
dont compress --用来指定那些在传输之前不进行压缩处理的文件。该选项可以定义一些不允许客户对该模块使用的命令选项列表。必须使用选项全名，而不能是简称。当发生拒绝某个选项的情况时，服务器将报告错误信息然后退出。例如，要防止使用压缩，应该是：”dont compress = *”。 *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz
模块文件筛选参数
exclude --指定多个由空格隔开的多个文件或目录(相对路径)，并将其添加到 exclude 列表中。这等同于在客户端命令中使用 –exclude 来指定模式
exclude from --指定一个包含 exclude 规则定义的文件名，服务器从该文件中读取 exclude 列表定义
include --指定多个由空格隔开的多个文件或目录(相对路径)，并将其添加到 include 列表中。这等同于在客户端命令中使用 –include 来指定模式
include from --指定一个包含 include 规则定义的文件名，服务器从该文件中读取 include 列表定义
模块用户认证参数
auth users --指定由空格或逗号分隔的用户名列表，只有这些用户才允许连接该模块（和系统用户没有任何关系）。用户名和口令以明文方式存放在 secrets file 参数指定的文件中。默认为匿名方式
secrets file --指定一个 rsync 认证口令文件。只有在 auth users 被定义时，该文件才起作用。文件权限必须是 600
strict modes --指定是否监测口令文件的权限。为 true 则口令文件只能被 rsync 服务器运行身份的用户访问，其他任何用户不可以访问该文件。默认为true
模块访问控制参数
hosts allow --用一个主机列表指定哪些主机客户允许连接该模块。不匹配主机列表的主机将被拒绝。默认值为 *
hosts deny --用一个主机列表指定哪些主机客户不允许连接该模块
模块日志参数
transfer logging --使 rsync 服务器将传输操作记录到传输日志文件。默认值为false
log format --指定传输日志文件的字段。默认为：”%o %h [%a] %m (%u) %f %l”
设置了”log file”参数时，在日志每行的开始会添加”%t [%p]“；
可以使用的日志格式定义符如下所示：
%o --操作类型：”send” 或 “recv”
%h --远程主机名
%a --远程IP地址
%m --模块名
%u --证的用户名（匿名时是 null）
%f --文件名
%l --文件长度字符数
%p --该次 rsync 会话的 PID
%P --模块路径
%t --当前时间
%b --实际传输的字节数
%c --当发送文件时，记录该文件的校验码


#### 守护进程模式使用
  Pull: rsync [OPTION...] [USER@]HOST::SRC... [DEST]
        rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]
  Push: rsync [OPTION...] SRC... [USER@]HOST::DEST
        rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST


https://www.cnblogs.com/george-guo/p/7718515.html
https://www.cnblogs.com/nb-blog/p/6340022.html
https://blog.csdn.net/qq_21419995/article/details/80458379