---
title: 用户行为研究系统分享
date: 2017/04/15 23:11:00
---


## 0 题外分享--如何作知识分享
### 0.1 背景知识  

做任何分享之前，必须把背景交代清楚。  
对一个不进行听众筛选的技术交流会，背景介绍至少要占20%-30%的篇幅。  

### 0.2 内容

介绍术语、概念、框架和流程比解释技术细节更重要。  
多讲what和why，少讲how。  
what和why占80%，how占20%。  

### 0.3 参考文献

请列出所有参考文献，帮助真正有兴趣的人找到他们想找的资料。

<!-- more -->

## 1 背景知识
### 1.1 项目背景

用户行为研究系统，大家都比较了解了，就是统计客户在网页访问了我们的网址多少次，他点击什么按钮最多，他用的什么设备。  
总结来说，要做以下三个功能：  
1、统计客户行为信息，找到使用最频繁的功能。  
2、统计客户设备信息，进行针对性优化。  
3、挖掘客户信息，优化操作流程。

### 1.2 需求背景

目前的需求主要集中在两个方面：  
1、对客户使用设备信息的统计，尤其是屏幕分辨率、浏览器信息的分布情况；  
2、对客户使用情况的统计，包括分客户的最多访问页面、最多点击等；  

### 1.3 技术背景

Node.js + Express + mongoDB  
#### 1.3.1 Node.js  
##### Node.js是什么？

Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。  
它能运行JavaScript代码，意味着我们前端可以使用JavaScript来写后台。 
 
##### 为什么选择Node？

1、Node.js适合运用在高并发、I/O密集、少量业务逻辑的场景。  
2、前端开发人员对JavaScript比较熟悉，能够完成服务端内容的开发。  

#### Express
##### Express是什么？

Express是基于 Node.js 平台，快速、开放、极简的 web 开发框架。  
就像Java中的SSH一样，封装了很多基本功能，提供了丰富的API，让我们的开发更加快速。  

##### 为什么选择Express？

1、简单、快速、提高效率。  
2、Express是最流行的，比较成熟，文档比较齐全。  

#### MongoDB
##### MongoDB是什么？

MongoDB是一个非关系型的数据库，他支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。  
MongoDB和MySQL的对比：
<table>
<tr><td>MongoDB</td><td>MySQL</td></tr>
<tr><td>数据库</td><td>数据库</td></tr>
<tr><td>集合</td><td>表</td></tr>
<tr><td>文档</td><td>记录</td></tr>
</table>
至于它的用法，见参考文档。   
 
##### 为什么选择MongoDB  

1、统计的数据量巨大，没有复杂的跨文档级联查询，适合使用MongoDB；  
2、MongoDB采用类JSON的格式进行数据存储，天生适合搭配NodeJS服务器。

## 2 如何搜集用户行为信息
### 2.1 用户行为信息的分类
#### 用户行为信息分为以下三类：  

1、静态信息  
目前包括浏览器信息、分辨率信息、操作系统信息、设备类型信息；  
2、访问信息  
目前包括PV、UV、IP。  
3、动态信息  
目前包括访问页面、点击按钮的信息。

#### 为什么要分为三类？

1、不同类型的信息提交的时机不同，静态信息为登录后，访问信息为登录后及打开页面后，动态信息为登录后及每次点击后；  
2、不同信息的存储方式和存储文档不同；  
3、不同信息的统计方式不同，静态信息按百分比、访问信息按时间段、动态信息按客户。 

### 2.2 搜集模块的逻辑结构

![](http://7xlvsv.com1.z0.glb.clouddn.com/%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E7%BB%9F%E8%AE%A11.bmp)  

整个用户行为搜集的逻辑结构分为两部分，一是搜集并提交到后台，二是后台接收数据并解析存库。  

#### 为什么是这个逻辑结构设计?

一是用户行为研究系统服务多个业务系统，放在哪个业务系统都会对原业务系统造成干扰；  
二是用户点击行为频繁，对于传统JavaEE服务器来说压力比较大；  
三是系统运行一段时间后数据量十分巨大，其统计操作比较消耗服务器资源，适合单独建立服务器，在服务器压力较小的时候执行统计操作。  

### 2.3 用户行为信息搜集的流程

![](http://7xlvsv.com1.z0.glb.clouddn.com/%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E7%BB%9F%E8%AE%A12.bmp)  

用户行为信息搜集的提交分为三种情况：  
一是登录后，提交一次数据；  
二是进入页面后，提交一次数据；  
三是每次动作发送后，提交一次数据。  

### 2.4 前端信息如何搜集？

借助支付宝的tracker.js，它基本上已经实现了所有的搜集工作，在我们的用户行为研究系统中对它进行了一点点的改造。  
改造一：由统计单个系统改为统计多个，采用增加一个参数的形式。  
改造二：静态信息的搜集和提交由默认的自动提交改为手动提交。  

#### 如何获得tracker.js ?

借助一段JavaScript代码，这段代码会把一个id提交到后台，这个id就是业务系统的唯一标识，也就是系统英文简称的md5字符串，这里的id用来唯一区分ebs还是gbs，又或者是gms。   
比如ebs系统中提交的id就是ebs的md5字符串：5adfcda6fac4906e45b800d34eb90fa1。  


	(function() {
        var hm = document.createElement("script");
        var host = window.location.host;
        hm.src = "//tongjitest.dataserver.cn/tracker?id=5adfcda6fac4906e45b800d34eb90fa1&host=" + host;
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
	
系统接收到这个请求以后，拿到这个id，组合成为提交数据的URL，然后写回到JavaScript文件中，再将这个JavaScript文件返回给页面。  

#### 那么它是如何实现信息搜集的？  

同样分为三类：  
1、静态信息：借助window.navigator和window.screen  
Navigator 对象包含有关浏览器的信息，包括浏览器名称、浏览器版本、操作系统名称、操作系统版本等等；  
登录以后主动触发静态信息发送事件。    

2、访问信息  
全局监听window的load事件，load事件会在整个页面加载完毕后触发。  
触发以后搜集访问信息并发送。

3、动态信息  
全局监听window的click事件。  
发生click事件以后，检测是否是埋了点的元素，如果是就搜集数据并发送。

#### 如何埋点？

借助menu.js自动埋点。  
埋点方式：增加一个自定义属性data-seed。  
data-seed属性的属性值包含了该按钮的信息：分别是元素所在区域-元素类型-元素值。  
举例：data-seed="0-2-1000"。  
代表页面区域的链接，其菜单编号为1000（维保管理）。  

### 2.5 数据如何提交？

新建一个img标签，借助img标签的src属性，将参数附加在src上，src的主机设置为统计服务器的地址。   
此处的src的域名和文件名部分就来自于前面系统前端提交过去的id，从而实现不同系统的区分。  

#### 为什么采用img标签的形式？

因为存在跨域问题，只要协议、域名、端口有任何一个不同，都被当作是不同的域，就会不允许提交数据。所以我们不能进行ajax的提交，但是img标签不同，它只是对图片地址进行引用，不会提交数据，不存在跨域问题。此时我们借助src，就可以把一些参数带到后台。

### 2.6 后台数据如何接收？

这里就涉及到了src属性的格式：域名/文件名?参数    
例如
`http://tongjitest.dataserver.cn/5adfcda6fac4906e45b800d34eb90fa1.gif?ref=%2F1.1%2Fsys%2Fpage%2Fhome.jsp&pg=%2F1.1%2Fupkeepnew%2Fpage%2Fupkeep%2FupkeepOrderList.jsp&cus=0000100056&rnd=1492227667738&BIProfile=load&uid=e6883851-2102-494f-8b47-e02c4c38c115`
被拆分以后就是：  
域名：http://tongjitest.dataserver.cn  
文件名：5adfcda6fac4906e45b800d34eb90fa1.gif  
参数：ref=%2F1.1%2Fsys%2Fpage%2Fhome.jsp&pg=%2F1.1%2Fupkeepnew%2Fpage%2Fupkeep%2FupkeepOrderList.jsp&cus=0000100056&rnd=1492227667738&BIProfile=load&uid=e6883851-2102-494f-8b47-e02c4c38c115 

这里的文件名是ebs的md5编码，用来唯一区分ebs还是gbs，又或者是gms。  
后面一大堆参数就是具体的提交上来的数据，后台首先取到文件名，根据文件名解析出是来自哪个系统的数据，然后根据数据的类型采取不同的解析方法，对应前台提交数据的规则进行解析。

#### 为什么文件名要这么用？

1、为了区分多个系统；  
2、为了防止别人的攻击。

### 2.7 后台数据如何存储？

#### 2.7.1 文档结构

文档结构根据统计信息的不同可以分为四类：  
1、网址访问信息（PV、UV、IP）  
所有的文档都包含customerCode和datetime属性。

为什么要包含客户代码和时间？
来源于实际需求：  
（1）根据客户进行过滤；  
（2）按时间段统计。

2、客户使用环境信息

同样所有的文档包含customerCode和date属性。  
原因同上。

3、访问最多页面和点击最多按钮  
同样所有的文档包含customerCode和date属性。  
原因同上。

4、客户活跃度  
客户活跃度是代表某个客户使用客户的总得分，这个得分依据三个值计算出来，分别是:  
1、登录用户数：该客户下登录过系统的用户总数；  
2、登录总次数：该客户下所有用户登录过的次数总和；  
3、操作总次数：该客户下所有用户操作的次数总和。  
计算公式为：活跃度值 = 登录用户数 * 0.2 + 登录总次数 * 0.3 + 操作总次数 * 0.5。  
为什么这么计算？  
参考业界活跃度计算规则得出。

#### 2.7.2 存放过程

##### 什么是中间件？

中间件是Express中的精髓，Express 是一个自身功能极简，完全是由路由和中间件构成一个的 web 开发框架：从本质上来说，一个 Express 应用就是在调用各种中间件。  
中间件（Middleware） 是一个函数，它可以访问请求对象（request object (req)）, 响应对象（response object (res)）, 和 web 应用中处于请求-响应循环流程中的中间件，一般被命名为 next 的变量。  
这么说你可能还是不理解，那么gulp大家现在都熟悉了，gulp中有流和管道的概念，这个中间件就像管道，request和response就像流，按照你所设定的规则，依次流过一个个管道。  
同时它又像SSH框架中的过滤器，所有来自前台的请求，都会经过中间件的过滤。  

##### 如何利用中间件处理不同类型的提交？

首先借助Express的路由，匹配所有包含.gif的请求，然后进入文件名解析中间件，根据文件名解析出对应的系统名称，比如根据5adfcda6fac4906e45b800d34eb90fa1得到ebs。  
得到系统名称以后，就把它放到request对象里面，由request对象带着它进入下一个中间件。  

后面还有三个中间件，分别用来处理三种类型的数据提交，每个中间件处理对应类型的数据解析和存储。   
三个中间件分别是：动态信息处理中间件、访问信息处理中间件、静态信息处理中间件。  

中间件进入的顺序是固定的，进入某一个中间件以后如果调用next()，则请求流会进入下一个中间件；如果直接操作response对象返回数据的话，就会返回数据到前端，不会再进入后面的中间件。  
为什么采用这个顺序？  
因为提交最多的请求必然是动态信息（每次点击就提交）、其次是访问信息（每次进入页面后提交）、最后是静态信息（每次登录后提交）。  

##### 每个中间件中做了什么处理？

利用Express的body-parser中间件得到一个query对象，这个query对象里面就存放着前台提交过来的参数，他把字符串类型的参数转换成了对象。 
 
##### 动态信息中间件

取得page、customerCode、time、seedName，分别存到点击统计文档、客户活跃度文档。  

##### 访问信息中间件

取得customerCode、userId、page、date、hour等，分别存放到PV文档、访问最多统计文档。

##### 静态信息中间件

1、保存设备信息：分辨率、浏览器版本、操作系统等等，分别写入对应的文档。  
2、保存访问信息：保存UV、IP、活跃度统计等等。

##### 此处是如何访问MongoDB数据库的？

如果想要访问数据库，必须要借助驱动，就像Java后台要访问MySQL数据库，都需要一个mysql-connector.jar这个一个类似的jar包。同样，Node访问MongoDB，也需要一个驱动。MongoDB提供了这个驱动（node-mongodb-native），我们可以借助这个驱动在Node中访问MongoDB。  
但是我们都知道，SSH架构后台访问MySQL都在用Hibernate，为什么？因为Hibernate将对数据库的操作封装为对对象的操作，从而大大简化代码，让我们能以操作对象的方式操作数据库。同样，在Node生态圈，也有这样一个工具，那就是Mongoose。

Mongoose库简而言之就是对node环境中MongoDB数据库操作的封装，一种对象模型工具，可以将数据库中的数据转换为JavaScript对象供我们使用。  
借助mongoose，系统后台就直接以对象方式将数据写入到了MongoDB中。

## 3 如何统计用户行为

### 有哪些东西需要统计？

1、客户端设备信息（浏览器、分辨率、操作系统等）  
2、网站访问情况（PV、UV、IP等）  
3、活跃客户信息  

### 如何统计？

首先做了四个页面，分别展示客户端设备信息、网站访问情况、网站访问情况图标、活跃客户信息。  
然后根据每个页面的请求去MongoDB里面查询具体的数据，查询出来以后返回到前台进行展示。  

### 如何让其他业务系统使用用户行为统计？

需要三个条件：  
1、使用标准menu.js，因为自动化埋点在menu.js文件中；  
2、页面增加JavaScript代码引入；  
3、新增对应的数据库；

### 如何查看其他业务系统的统计结果？

这个还需要再进行开发，因为目前前端页面是默认为ebs系统的结果。

## 4 我踩的坑

### npm

windows平台下一定不要使用cnpm，要使用npm后面指定阿里的仓库。  
即： npm install xxx --registry=https://registry.npm.taobao.org  

#### npm是什么？

npm是一个包管理平台，就类似于maven，区别只是一个管理的是JavaScript包，一个管理的是Java包。
  
#### cnpm是什么？为什么不要使用cnpm？又为什么要指定阿里的仓库？

cnpm是阿里巴巴提供的npm工具，因为npm的官方仓库在国外，阿里巴巴在国内建立了相应的仓库，本来cnpm就是在npm的后面指定了阿里的仓库，但是在windows环境下面，会导致包混乱。但是如果我们访问npm的官方库的话，又会很慢，其实阿里的仓库没有问题，只是cnpm在windows平台有问题，所以我们使用npm指定阿里仓库就好。

### 异步回调

Node编程中处处是回调，一不小心就会陷入回调噩梦。访问数据库的异步回调非常多，因为有时候需要依次写入三张表的话，那就需要等第一个表写完再写第二个，第二个写完再写第三个，如果你把每一个回调函数连起来写，那你想想有多可怕。  
所以此时要使用Nodejs异步流程控制工具Async，类似的工具有很多，比如callback、promise、generator等，我选择的是Async。

## 5 参考文献

### 项目代码及文档
https://10.44.218.8:8001/svn/1407/13-FE/01-UserBehaviorResearch/01-trunk/v1.0

### node
书籍：《深入浅出Nodejs》  
http://nodejs.cn/

### Express
http://www.expressjs.com.cn/

### MongoDB
http://lib.csdn.net/base/mongodb?page=1&type=1#md

### mongoose
http://mongoosejs.com/docs/index.html

### Async
http://caolan.github.io/async/

